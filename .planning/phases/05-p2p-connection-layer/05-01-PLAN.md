---
phase: 05-p2p-connection-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/package.json
  - assets/js/peerjs-ports.ts
  - assets/js/app.ts
  - assets/src/Ports.elm
  - assets/src/Main.elm
autonomous: true

must_haves:
  truths:
    - "PeerJS library is installed and importable"
    - "Elm can send createRoom command and receive roomCreated event"
    - "Elm can send joinRoom command and receive peerConnected event"
    - "Connection errors from PeerJS reach Elm as connectionError events"
    - "Connection state is tracked in Elm model"
  artifacts:
    - path: "assets/js/peerjs-ports.ts"
      provides: "PeerJS integration with Elm port handlers"
      exports: ["setupPeerPorts"]
    - path: "assets/src/Ports.elm"
      provides: "P2P ports (createRoom, joinRoom, leaveRoom, roomCreated, peerConnected, peerDisconnected, connectionError)"
      contains: "port createRoom"
  key_links:
    - from: "assets/js/app.ts"
      to: "assets/js/peerjs-ports.ts"
      via: "import and call setupPeerPorts(app)"
      pattern: "setupPeerPorts"
    - from: "assets/src/Main.elm"
      to: "assets/src/Ports.elm"
      via: "subscriptions using Ports.roomCreated, Ports.peerConnected, etc"
      pattern: "Ports\\.roomCreated"
---

<objective>
Establish P2P connection infrastructure using PeerJS integrated with Elm via bidirectional ports.

Purpose: Foundation layer that enables Create/Join room functionality. This plan installs PeerJS, creates the JavaScript port handlers for PeerJS events, adds P2P ports to Elm, and wires the connection state machine.

Output: Working port bridge where Elm can send createRoom/joinRoom commands and receive connection events. No UI yet - that's Plan 02.
</objective>

<execution_context>
@/Users/julian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-p2p-connection-layer/05-RESEARCH.md
@.planning/phases/05-p2p-connection-layer/05-CONTEXT.md
@assets/js/app.ts
@assets/js/socket.ts
@assets/src/Ports.elm
@assets/src/Main.elm
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PeerJS and create peerjs-ports.ts</name>
  <files>
    assets/package.json
    assets/js/peerjs-ports.ts
    assets/js/app.ts
  </files>
  <action>
1. Install PeerJS:
   ```bash
   cd assets && npm install peerjs@1.5.5
   ```

2. Create `assets/js/peerjs-ports.ts` with:
   - Interface for P2P-specific Elm ports (createRoom, joinRoom, leaveRoom outgoing; roomCreated, peerConnected, peerDisconnected, connectionError, copyToClipboard/clipboardCopySuccess incoming)
   - `setupPeerPorts(app)` function that:
     a. Maintains peer instance in module scope (not Elm - peer objects not serializable)
     b. Maintains connections map for host (Map<string, DataConnection>)
     c. Subscribes to `app.ports.createRoom`:
        - Generate 4-letter room code (A-Z only, use `generateRoomCode()` helper)
        - Create `new Peer(roomCode, { host: 'peerjs.com', secure: true })`
        - On peer `open` event: `app.ports.roomCreated.send(id)`
        - On peer `error` event: map to user-friendly message and `app.ports.connectionError.send(msg)`
        - On peer `connection` event (client connecting to host): store connection, setup data handlers, `app.ports.peerConnected.send({ role: 'host', peerId: conn.peer })`
     d. Subscribes to `app.ports.joinRoom`:
        - If no peer exists, create `new Peer()` (random ID for client)
        - On peer `open`: `peer.connect(roomCode)`
        - On connection `open`: `app.ports.peerConnected.send({ role: 'client', roomCode })`
        - On connection `error`: map to message and send via connectionError port
        - On connection `close`: `app.ports.peerDisconnected.send(roomCode)`
        - Implement 10-second timeout (clear on success, fire connectionError on timeout)
     e. Subscribes to `app.ports.leaveRoom`:
        - Close all connections
        - Destroy peer
        - Reset module state
     f. Subscribes to `app.ports.copyToClipboard`:
        - Use `navigator.clipboard.writeText(text)`
        - On success: `app.ports.clipboardCopySuccess.send(null)`
   - Helper `generateRoomCode()`: 4 random letters A-Z
   - Helper `errorToMessage(err)`: Maps PeerJS error types to user-friendly strings
     - 'peer-unavailable' -> 'Room not found'
     - 'unavailable-id' -> 'Room code already in use'
     - 'network' -> 'Connection failed - check your internet'
     - default -> 'Connection failed'

3. Update `assets/js/app.ts`:
   - Import `setupPeerPorts` from './peerjs-ports'
   - Call `setupPeerPorts(app)` after Elm init (alongside existing `connectSocket(app)`)
   - Update ElmApp interface to include P2P ports

CRITICAL: Listen for errors on BOTH `peer.on('error')` and `conn.on('error')` - PeerJS routes some errors to peer object, not connection (Issue #1281).
  </action>
  <verify>
    - `npm ls peerjs` shows peerjs@1.5.5
    - `assets/js/peerjs-ports.ts` exists with setupPeerPorts export
    - TypeScript compiles without errors: `cd assets && npx tsc --noEmit`
  </verify>
  <done>
    PeerJS installed, peerjs-ports.ts created with complete port handlers, app.ts imports and calls setupPeerPorts
  </done>
</task>

<task type="auto">
  <name>Task 2: Add P2P ports to Elm and wire connection state</name>
  <files>
    assets/src/Ports.elm
    assets/src/Main.elm
  </files>
  <action>
1. Update `assets/src/Ports.elm`:
   - Add outgoing ports:
     - `port createRoom : () -> Cmd msg`
     - `port joinRoom : String -> Cmd msg`
     - `port leaveRoom : () -> Cmd msg`
     - `port copyToClipboard : String -> Cmd msg`
   - Add incoming ports:
     - `port roomCreated : (String -> msg) -> Sub msg`
     - `port peerConnected : (JD.Value -> msg) -> Sub msg`
     - `port peerDisconnected : (String -> msg) -> Sub msg`
     - `port connectionError : (String -> msg) -> Sub msg`
     - `port clipboardCopySuccess : (() -> msg) -> Sub msg`
   - Update module exposing list

2. Update `assets/src/Main.elm`:
   - Add `P2PConnectionState` type:
     ```elm
     type P2PConnectionState
         = P2PNotConnected
         | P2PCreatingRoom
         | P2PJoiningRoom String  -- room code being joined
         | P2PConnected P2PRole String  -- role and room code

     type P2PRole
         = Host
         | Client
     ```
   - Add to Model:
     - `p2pState : P2PConnectionState`
     - `roomCodeInput : String` (for join input)
     - `showCopiedFeedback : Bool`
   - Add Msg variants:
     - `CreateRoom`
     - `JoinRoom`
     - `LeaveRoom`
     - `RoomCodeInputChanged String`
     - `GotRoomCreated String`
     - `GotPeerConnected JD.Value`
     - `GotPeerDisconnected String`
     - `GotConnectionError String`
     - `CopyRoomCode`
     - `GotClipboardCopySuccess`
     - `HideCopiedFeedback`
   - Update `init` to initialize:
     - `p2pState = P2PNotConnected`
     - `roomCodeInput = ""`
     - `showCopiedFeedback = False`
   - Add update cases:
     - `CreateRoom`: set state to P2PCreatingRoom, send `Ports.createRoom ()`
     - `JoinRoom`: set state to P2PJoiningRoom roomCodeInput, send `Ports.joinRoom roomCodeInput`
     - `LeaveRoom`: send `Ports.leaveRoom ()`, set state to P2PNotConnected
     - `RoomCodeInputChanged str`: uppercase, store, auto-join if 4 chars
     - `GotRoomCreated roomCode`: set state to `P2PConnected Host roomCode`
     - `GotPeerConnected value`: decode role/roomCode, set state to P2PConnected
     - `GotPeerDisconnected _`: set state to P2PNotConnected, show toast "Disconnected"
     - `GotConnectionError msg`: set state appropriately (NotConnected or back from Creating/Joining), show toast with msg, auto-dismiss 5s
     - `CopyRoomCode`: send `Ports.copyToClipboard roomCode`
     - `GotClipboardCopySuccess`: set showCopiedFeedback True, schedule HideCopiedFeedback in 2s
     - `HideCopiedFeedback`: set showCopiedFeedback False
   - Add subscriptions for new ports in `subscriptions` function
   - Create decoder for peerConnected data:
     ```elm
     peerConnectedDecoder : JD.Decoder { role : P2PRole, roomCode : String }
     peerConnectedDecoder =
         JD.map2 (\role roomCode -> { role = role, roomCode = roomCode })
             (JD.field "role" (JD.string |> JD.andThen roleDecoder))
             (JD.oneOf
                 [ JD.field "roomCode" JD.string
                 , JD.field "peerId" JD.string  -- host receives peerId from connecting client
                 ]
             )

     roleDecoder : String -> JD.Decoder P2PRole
     roleDecoder str =
         case str of
             "host" -> JD.succeed Host
             "client" -> JD.succeed Client
             _ -> JD.fail "Unknown role"
     ```

NOTE: This task adds state and handlers but NO UI changes yet. UI is Plan 02.
  </action>
  <verify>
    - `cd assets && npm run build` succeeds (Elm compiles)
    - Ports.elm exposes all new ports
    - Main.elm has P2PConnectionState type and all new Msg variants
    - App runs without errors (even though P2P UI not visible yet)
  </verify>
  <done>
    Ports.elm has P2P ports, Main.elm has P2PConnectionState with all handlers wired, subscriptions active
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd assets && npm run build` succeeds
2. `npm ls peerjs` shows 1.5.5
3. Browser console shows no errors on page load
4. TypeScript compiles: `cd assets && npx tsc --noEmit`

Manual testing (prepare for Plan 02):
- Open browser console
- Manually call: `app.ports.createRoom.send(null)` (if accessible)
- Should see PeerJS initialization in console logs
</verification>

<success_criteria>
- PeerJS 1.5.5 installed in package.json
- peerjs-ports.ts exists with setupPeerPorts function handling all port subscriptions
- app.ts imports and calls setupPeerPorts
- Ports.elm exports createRoom, joinRoom, leaveRoom, roomCreated, peerConnected, peerDisconnected, connectionError, copyToClipboard, clipboardCopySuccess
- Main.elm has P2PConnectionState type, all Msg variants, update handlers, and subscriptions
- Build succeeds, app runs without console errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-p2p-connection-layer/05-01-SUMMARY.md`
</output>
