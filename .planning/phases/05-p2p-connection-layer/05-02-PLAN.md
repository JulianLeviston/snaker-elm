---
phase: 05-p2p-connection-layer
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - assets/src/Main.elm
  - assets/src/View/ConnectionUI.elm
  - assets/css/app.css
autonomous: false

must_haves:
  truths:
    - "Player can click Create button and see a 4-letter room code displayed"
    - "Player can enter a room code and auto-connect after 4 characters"
    - "Connection status text is visible at top of game area"
    - "Error messages appear as toast and auto-dismiss after 5 seconds"
    - "Copy button shows 'Copied!' feedback"
  artifacts:
    - path: "assets/src/View/ConnectionUI.elm"
      provides: "Create/Join UI component with room code display, input, and status"
      exports: ["view"]
    - path: "assets/css/app.css"
      provides: "Styles for connection UI elements"
      contains: ".connection-panel"
  key_links:
    - from: "assets/src/Main.elm"
      to: "assets/src/View/ConnectionUI.elm"
      via: "ConnectionUI.view called in Main.view"
      pattern: "ConnectionUI\\.view"
    - from: "assets/src/View/ConnectionUI.elm"
      to: "assets/src/Main.elm"
      via: "Msg types passed to button handlers"
      pattern: "onClick.*CreateRoom\\|JoinRoom"
---

<objective>
Build the connection UI for Create/Join room functionality with status display and error handling.

Purpose: Users can create rooms, join rooms via code input, see connection status, and receive error feedback. This completes Phase 5 requirements for peer connection establishment.

Output: Functional Create/Join UI with room code display, auto-uppercase input, spinner during connection, status line, and toast error messages.
</objective>

<execution_context>
@/Users/julian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-p2p-connection-layer/05-RESEARCH.md
@.planning/phases/05-p2p-connection-layer/05-CONTEXT.md
@.planning/phases/05-p2p-connection-layer/05-01-SUMMARY.md
@assets/src/Main.elm
@assets/src/View/Notifications.elm
@assets/css/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionUI view module</name>
  <files>
    assets/src/View/ConnectionUI.elm
  </files>
  <action>
Create `assets/src/View/ConnectionUI.elm` module that renders connection UI based on P2P state.

```elm
module View.ConnectionUI exposing (view)

import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onInput)
```

The view function signature:
```elm
view :
    { p2pState : P2PConnectionState
    , roomCodeInput : String
    , showCopiedFeedback : Bool
    , onCreateRoom : msg
    , onJoinRoom : msg
    , onLeaveRoom : msg
    , onRoomCodeInput : String -> msg
    , onCopyRoomCode : msg
    }
    -> Html msg
```

Render based on p2pState:

**P2PNotConnected:**
- Create button and Join button inline
- When user clicks Join, show text input that expands inline (use a flag or derive from roomCodeInput non-empty)
- Actually, simpler: always show input below buttons, it appears when user starts typing or clicks Join
- Input: 4-char max, placeholder "ABCD", auto-uppercase (handled by msg), monospace font
- No submit button - auto-connects at 4 chars

**P2PCreatingRoom:**
- Show "Creating room..." with spinner
- Cancel button to return to NotConnected

**P2PJoiningRoom roomCode:**
- Show "Joining {roomCode}..." with spinner
- Cancel button to return to NotConnected

**P2PConnected Host roomCode:**
- Large, centered room code display (e.g., "XBQR")
- Copy button next to code
- If showCopiedFeedback: show "Copied!" text instead of/next to copy button
- Leave button
- Status text: "Hosting room {roomCode}"

**P2PConnected Client roomCode:**
- Status text: "Connected to {roomCode}"
- Leave button

Structure:
```elm
view config =
    div [ class "connection-panel" ]
        [ case config.p2pState of
            P2PNotConnected ->
                viewNotConnected config

            P2PCreatingRoom ->
                viewCreating config

            P2PJoiningRoom code ->
                viewJoining code config

            P2PConnected Host roomCode ->
                viewConnectedHost roomCode config

            P2PConnected Client roomCode ->
                viewConnectedClient roomCode config
        ]
```

Helper views:
- `viewNotConnected`: Create/Join buttons, input field
- `viewCreating`: Spinner + "Creating room..." + Cancel
- `viewJoining`: Spinner + "Joining {code}..." + Cancel
- `viewConnectedHost`: Large room code, copy button, copied feedback, Leave
- `viewConnectedClient`: Status text, Leave button

Spinner: Use simple CSS animation or Unicode spinner character with rotation class.

NOTE: Import P2PConnectionState and P2PRole types from Main.elm, or define them in a shared module. For simplicity, pass the state as opaque and use pattern matching - but since Elm requires types, either:
- Option A: Define types in this module and have Main import them (cleaner)
- Option B: Pass primitive config values (messier)

Go with Option A: Define `P2PConnectionState` and `P2PRole` in `View.ConnectionUI` and have Main.elm import them.
  </action>
  <verify>
    - `assets/src/View/ConnectionUI.elm` exists
    - Module compiles: `cd assets && npm run build`
    - Exports view function and P2PConnectionState, P2PRole types
  </verify>
  <done>
    ConnectionUI.elm created with view function rendering all connection states, types defined and exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ConnectionUI into Main and add CSS</name>
  <files>
    assets/src/Main.elm
    assets/css/app.css
  </files>
  <action>
1. Update `assets/src/Main.elm`:
   - Remove local P2PConnectionState and P2PRole type definitions
   - Import from View.ConnectionUI: `import View.ConnectionUI as ConnectionUI exposing (P2PConnectionState(..), P2PRole(..))`
   - In `view` function, add ConnectionUI.view call:
     ```elm
     view model =
         div [ class "game-container", style "padding" "20px" ]
             [ h1 [] [ text "Snaker - Elm 0.19.1" ]
             , ConnectionUI.view
                 { p2pState = model.p2pState
                 , roomCodeInput = model.roomCodeInput
                 , showCopiedFeedback = model.showCopiedFeedback
                 , onCreateRoom = CreateRoom
                 , onJoinRoom = JoinRoom
                 , onLeaveRoom = LeaveRoom
                 , onRoomCodeInput = RoomCodeInputChanged
                 , onCopyRoomCode = CopyRoomCode
                 }
             , viewStatus model
             -- ... rest of existing view
             ]
     ```
   - Position the ConnectionUI at top of game area (before or after status line, based on layout)

2. Update `assets/css/app.css` with connection UI styles:

```css
/* ==========================================================================
   Connection UI
   ========================================================================== */

.connection-panel {
    margin-bottom: 20px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 8px;
}

/* Create/Join buttons */
.connection-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
}

.connection-buttons button {
    padding: 10px 20px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-create {
    background: #4CAF50;
    color: white;
}

.btn-create:hover {
    background: #45a049;
}

.btn-join {
    background: #2196F3;
    color: white;
}

.btn-join:hover {
    background: #1976D2;
}

.btn-leave {
    background: #f44336;
    color: white;
}

.btn-leave:hover {
    background: #d32f2f;
}

.btn-cancel {
    background: #9e9e9e;
    color: white;
}

.btn-cancel:hover {
    background: #757575;
}

/* Room code input */
.room-code-input {
    font-family: monospace;
    font-size: 18px;
    letter-spacing: 4px;
    text-transform: uppercase;
    padding: 10px 16px;
    width: 120px;
    text-align: center;
    border: 2px solid #ddd;
    border-radius: 4px;
}

.room-code-input:focus {
    outline: none;
    border-color: #2196F3;
}

/* Room code display (host) */
.room-code-display {
    text-align: center;
    margin: 20px 0;
}

.room-code {
    font-family: monospace;
    font-size: 48px;
    font-weight: bold;
    letter-spacing: 8px;
    color: #333;
}

.copy-button {
    margin-left: 16px;
    padding: 8px 16px;
    font-size: 14px;
    background: #e0e0e0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.copy-button:hover {
    background: #d0d0d0;
}

.copied-feedback {
    color: #4CAF50;
    font-size: 14px;
    margin-left: 8px;
}

/* Connection status */
.connection-status {
    font-size: 14px;
    color: #666;
    margin-top: 12px;
}

.connection-status.connected {
    color: #4CAF50;
}

/* Spinner */
.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ddd;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Connecting state */
.connecting-state {
    display: flex;
    align-items: center;
    gap: 12px;
}
```

3. Update toast styles if needed for error messages (existing toast should work, but verify 5s duration):
   - Current toast has 3s animation
   - For connection errors, we want 5s visibility
   - Add `.toast.error` variant with 5s animation OR rely on Elm's Process.sleep for dismissal
   - Since Elm controls dismissal via Process.sleep 5000, keep CSS animation but extend it:
   ```css
   .toast.connection-error {
       animation: slideInFadeOut 5s ease-out forwards;
   }
   ```
   - Update @keyframes timing: 0% -> 6% (300ms in), 94% -> 100% (300ms out)
  </action>
  <verify>
    - `cd assets && npm run build` succeeds
    - Open app in browser
    - Create and Join buttons visible
    - CSS styles applied (buttons have colors, proper spacing)
  </verify>
  <done>
    Main.elm imports ConnectionUI and renders it, CSS styles added for all connection UI states
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete P2P connection UI with Create/Join functionality:
- Create button generates room code and displays it prominently
- Join input auto-uppercases and auto-connects at 4 characters
- Spinner shown during connection attempts
- Status line shows connection state
- Copy button with "Copied!" feedback
- Leave button to disconnect
- Error toasts auto-dismiss after 5 seconds
  </what-built>
  <how-to-verify>
1. Start the app: `cd /Users/julian/code/elm/snaker-elm && mix phx.server` (or however app runs)
2. Open http://localhost:4000 in browser

**Test Create Room (Tab 1):**
- Click "Create" button
- Should see spinner with "Creating room..."
- After ~1 second, should see large 4-letter room code (e.g., "XBQR")
- Click copy button - should see "Copied!" feedback
- Status should show "Hosting room XBQR"
- Leave button should be visible

**Test Join Room (Tab 2):**
- Open second browser tab
- Type room code from Tab 1 into join input
- Letters should auto-uppercase as you type
- After 4th character, should see "Joining XBQR..." with spinner
- After connection, status should show "Connected to XBQR"
- Leave button visible

**Test Errors:**
- In new tab, enter invalid room code like "ZZZZ"
- Should see "Joining ZZZZ..." then error toast "Room not found"
- Toast should auto-dismiss after ~5 seconds
- UI should return to Create/Join buttons

**Test Leave:**
- Click Leave in connected tab
- Should return to Create/Join buttons
- Other peer should see disconnection (status changes)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 5 success criteria (from ROADMAP.md):
1. Player can create a room and see a room code displayed - verified via Create flow
2. Player can enter a room code and connect to the room creator - verified via Join flow
3. Connection status (connecting/connected/disconnected) is visible - verified via status line
4. Clear error message appears when connection fails - verified via error toast
</verification>

<success_criteria>
- ConnectionUI.elm created with view function for all P2P states
- Main.elm imports and renders ConnectionUI
- CSS styles applied for buttons, input, room code display, spinner, status
- Create button works: shows spinner, then displays room code
- Join input works: auto-uppercase, auto-connect at 4 chars
- Copy button shows "Copied!" feedback
- Error toasts appear and auto-dismiss after 5 seconds
- Leave button disconnects and returns to initial state
- Two browser tabs can create and join rooms with each other
</success_criteria>

<output>
After completion, create `.planning/phases/05-p2p-connection-layer/05-02-SUMMARY.md`
</output>
