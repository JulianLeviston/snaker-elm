---
phase: 03-integration-sync
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - assets/src/View/Scoreboard.elm
  - assets/src/View/Notifications.elm
  - assets/src/Main.elm
autonomous: false

must_haves:
  truths:
    - "Scoreboard shows all players sorted by snake length"
    - "Toast notifications appear on player join/leave"
    - "Game state updates on every server tick"
    - "Multiple browser windows show identical snake positions"
  artifacts:
    - path: "assets/src/View/Scoreboard.elm"
      provides: "Player leaderboard component"
      exports: ["view"]
    - path: "assets/src/View/Notifications.elm"
      provides: "Toast notification component"
      exports: ["view"]
    - path: "assets/src/Main.elm"
      provides: "Complete game integration"
      contains: "GotTick"
  key_links:
    - from: "assets/src/Main.elm"
      to: "GotTick handler"
      via: "state replacement"
      pattern: "GotTick.*gameState.*Just"
    - from: "assets/src/Main.elm"
      to: "Scoreboard.view"
      via: "import and call"
      pattern: "Scoreboard\\.view"
---

<objective>
Complete game integration with scoreboard, notifications, and tick-based state sync.

Purpose: This plan delivers the core sync functionality. Server ticks update client state atomically, ensuring all players see identical game state. UI components provide player feedback.

Output: Working multiplayer game with synchronized state, scoreboard, and join/leave notifications.
</objective>

<execution_context>
@/Users/julian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration-sync/03-RESEARCH.md
@.planning/phases/03-integration-sync/03-01-SUMMARY.md
@.planning/phases/03-integration-sync/03-02-SUMMARY.md

@assets/src/Main.elm
@assets/src/Game.elm
@assets/src/Snake.elm
@assets/src/View/Board.elm
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Scoreboard and Notifications view modules</name>
  <files>assets/src/View/Scoreboard.elm, assets/src/View/Notifications.elm</files>
  <action>
**Scoreboard.elm:**

Create module at assets/src/View/Scoreboard.elm:
```elm
module View.Scoreboard exposing (view)
```

1. View function signature:
   ```elm
   view : List Snake -> Maybe String -> Html msg
   ```
   Takes snake list and current player ID (for "you" indicator)

2. Sort snakes by body length descending (longest first):
   ```elm
   List.sortBy (\s -> negate (List.length s.body)) snakes
   ```

3. Render each player entry:
   - Color dot (div with background-color from snake.color)
   - Player name (snake.name)
   - Score (List.length snake.body)
   - "(You)" suffix if snake.id matches playerId

4. Use CSS classes: `.scoreboard`, `.player-entry`, `.player-color`, `.player-name`, `.player-score`

**Notifications.elm:**

Create module at assets/src/View/Notifications.elm:
```elm
module View.Notifications exposing (view)
```

1. View function signature:
   ```elm
   view : Maybe String -> Html msg
   ```
   Takes optional notification message

2. Render toast div with `.toast` class when message exists
3. Return empty text node when no message

Keep both modules simple. The toast timing (3s auto-dismiss) is handled by CSS animation, but Main.elm will need to clear the notification after animation completes.
  </action>
  <verify>
Run `cd assets && npm run build` — both modules compile without errors.
  </verify>
  <done>
Scoreboard.elm renders sorted player list with scores. Notifications.elm renders toast messages with CSS animation class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire tick, join, and leave handlers in Main.elm</name>
  <files>assets/src/Main.elm</files>
  <action>
Update Main.elm with complete game integration:

1. **Add imports:**
   - `import View.Scoreboard as Scoreboard`
   - `import View.Notifications as Notifications`
   - `import Process`
   - `import Task`

2. **Update Model:**
   - Add `notification : Maybe String` for toast messages
   - Add `lastJoinedPlayer : Maybe String` for tracking join events

3. **Add Msg variants:**
   - `ClearNotification` — fired after toast timeout

4. **Update GotTick handler:**
   - Decode tick payload as GameState (same decoder as GotGameState)
   - Replace model.gameState with new state atomically
   - This is the critical sync point — full state replacement, not merge

5. **Update PlayerJoined handler:**
   - Decode player data: `{ id: String, name: String, colour: String }`
   - Set notification: "PlayerName joined"
   - If this is our join (compare with model.playerId), store the player ID
   - Schedule ClearNotification after 3 seconds: `Process.sleep 3000 |> Task.perform (\_ -> ClearNotification)`

6. **Update PlayerLeft handler:**
   - Decode: `{ player_id: Int }`
   - Set notification: "Player left" (we may not have their name anymore)
   - Schedule ClearNotification

7. **Add ClearNotification handler:**
   - Set model.notification to Nothing

8. **Update view:**
   - Add Scoreboard.view below the game board
   - Add Notifications.view for toast overlay
   - Layout: game board on left/center, scoreboard on right or below
   - Structure:
     ```elm
     div [ class "game-layout" ]
         [ div [ class "game-main" ]
             [ Board.view state model.playerId ]
         , Scoreboard.view state.snakes model.playerId
         ]
     , Notifications.view model.notification
     ```

9. **Handle initial state from join:**
   - The socket.ts already sends initial game_state on successful join
   - GotGameState already handles this — ensure it works with new Model fields
  </action>
  <verify>
Run `cd assets && npm run build` — compiles. Start server with `mix phx.server`. Open browser:
1. See game board rendering
2. See scoreboard with your snake
3. Open second browser tab — see toast notification in first tab
4. Both tabs show snakes in same positions
  </verify>
  <done>
Main.elm handles tick events with atomic state replacement. Join/leave events show toast notifications. Scoreboard displays all players sorted by score.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify multiplayer synchronization</name>
  <what-built>Complete multiplayer snake game with synchronized state across clients</what-built>
  <how-to-verify>
**Test procedure:**

1. Start the server: `mix phx.server`
2. Open browser A at http://localhost:4000
3. Observe: Your snake appears, scoreboard shows 1 player
4. Open browser B at http://localhost:4000 (different tab or window)
5. Observe in browser A: Toast notification "X joined", scoreboard shows 2 players
6. Observe in browser B: Both snakes visible, scoreboard shows 2 players

**Synchronization test:**

7. In browser A: Press arrow keys to change direction
8. Observe in browser B: Snake A moves in new direction within 100ms
9. Watch both browsers for 30 seconds
10. Verify: Snake positions match exactly in both windows (no drift)

**Apple test:**

11. Navigate a snake to eat an apple
12. Verify: Apple disappears in BOTH browsers simultaneously
13. Verify: Snake grows in BOTH browsers

**Disconnect test:**

14. Close browser B tab
15. Observe in browser A: Toast "Player left", scoreboard shows 1 player
16. Verify: Browser B's snake disappears from browser A's view

**Expected results:**
- All position updates synchronize within one tick (100ms)
- No visual drift over time
- Join/leave notifications work
- Scoreboard updates in real-time
  </how-to-verify>
  <resume-signal>Type "approved" if sync works correctly, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
1. `cd assets && npm run build` compiles without errors
2. `mix phx.server` serves the game
3. Two browser windows show identical snake positions
4. Toast notifications appear on player join/leave
5. Scoreboard shows all players sorted by length
6. Arrow keys control your snake in both windows
7. Apple eating syncs across all clients
</verification>

<success_criteria>
SYNC-02: Server broadcasts full state on player join (via initial game_state)
SYNC-03: All connected players see each other's snakes in correct positions immediately
- New player sees existing snakes within one tick
- Existing players see new player's snake within one tick
- No position drift over 60 seconds of gameplay
- Player disconnect removes snake from all views immediately
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-sync/03-03-SUMMARY.md`
</output>
