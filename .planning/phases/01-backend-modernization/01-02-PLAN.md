---
phase: 01-backend-modernization
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - mix.exs
  - mix.lock
  - config/config.exs
  - config/dev.exs
  - config/prod.exs
  - config/test.exs
  - lib/snaker_web/endpoint.ex
  - lib/snaker_web/channels/user_socket.ex
  - lib/snaker/application.ex
autonomous: true

must_haves:
  truths:
    - "Phoenix server starts on 1.7.x without compilation errors"
    - "WebSocket connections work via Phoenix 1.7 transport"
    - "JSON encoding/decoding uses Jason (not Poison)"
    - "All mix dependencies resolve without conflicts"
  artifacts:
    - path: "mix.exs"
      provides: "Phoenix 1.7.x, plug_cowboy, Jason dependencies"
      contains: "phoenix.*1.7"
    - path: "config/config.exs"
      provides: "Jason as JSON library, PubSub 2.0 config"
      contains: "json_library, Jason"
    - path: "lib/snaker_web/endpoint.ex"
      provides: "Socket with websocket: true option"
      contains: "websocket: true"
  key_links:
    - from: "mix.exs"
      to: "config/config.exs"
      via: "Jason dependency used in config"
      pattern: "jason.*1\\."
    - from: "lib/snaker_web/endpoint.ex"
      to: "lib/snaker_web/channels/user_socket.ex"
      via: "socket declaration references UserSocket"
      pattern: "SnakerWeb\\.UserSocket"
---

<objective>
Upgrade Phoenix from 1.3 to 1.7.x with all required dependency and configuration changes.

Purpose: Establish modern Phoenix 1.7 infrastructure with WebSocket transport, Jason JSON encoding, and updated PubSub configuration. This is the foundation for server-authoritative game state.
Output: Phoenix 1.7.x server that compiles, starts, and accepts WebSocket connections.
</objective>

<execution_context>
@/Users/julian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/01-backend-modernization/01-RESEARCH.md
@.planning/phases/01-backend-modernization/01-CONTEXT.md
@.planning/phases/01-backend-modernization/01-01-SUMMARY.md
@mix.exs
@config/config.exs
@lib/snaker_web/endpoint.ex
@lib/snaker_web/channels/user_socket.ex
@lib/snaker/application.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade mix.exs dependencies</name>
  <files>mix.exs</files>
  <action>
Update mix.exs with Phoenix 1.7.x dependencies. Key changes:

1. **Elixir version**: Change `~> 1.4` to `~> 1.15`

2. **Remove :phoenix compiler**: Change `compilers: [:phoenix, :gettext] ++ Mix.compilers` to `compilers: Mix.compilers` (or remove compilers line entirely - not needed in Elixir 1.11+)

3. **Update deps**:
```elixir
defp deps do
  [
    {:phoenix, "~> 1.7.0"},
    {:phoenix_pubsub, "~> 2.0"},
    {:phoenix_html, "~> 3.0"},
    {:phoenix_live_reload, "~> 1.0", only: :dev},
    {:gettext, "~> 0.20"},
    {:jason, "~> 1.0"},
    {:plug_cowboy, "~> 2.0"}
  ]
end
```

Remove: `{:cowboy, "~> 1.0"}` (replaced by plug_cowboy)
Add: `{:jason, "~> 1.0"}` and `{:plug_cowboy, "~> 2.0"}`

4. **Update Supervisor.Spec** in application.ex:
The old syntax uses deprecated `supervisor/2` and `worker/2` - update to child spec tuples.
  </action>
  <verify>
1. `mix deps.get` succeeds without errors
2. `mix deps.compile` succeeds
3. No warnings about deprecated :phoenix compiler
  </verify>
  <done>mix.exs has Phoenix 1.7.x deps, Elixir ~> 1.15, Jason, plug_cowboy</done>
</task>

<task type="auto">
  <name>Task 2: Update configs for Phoenix 1.7</name>
  <files>config/config.exs, config/dev.exs, config/prod.exs, config/test.exs</files>
  <action>
Update all config files for Phoenix 1.7 compatibility:

**config/config.exs:**
1. Add Jason as global JSON library:
   ```elixir
   config :phoenix, :json_library, Jason
   ```

2. Update PubSub config (Phoenix 2.0 syntax):
   Change from:
   ```elixir
   pubsub: [name: Snaker.PubSub, adapter: Phoenix.PubSub.PG2]
   ```
   To:
   ```elixir
   pubsub_server: Snaker.PubSub
   ```
   (Adapter config moves to Application supervision tree)

**config/dev.exs, config/prod.exs, config/test.exs:**
- Search for any Poison references and replace with Jason
- Update any deprecated config keys

**Note:** The PubSub server needs to be added to the supervision tree in application.ex with the adapter specified there.
  </action>
  <verify>
1. `grep -r "Poison" config/` returns no matches
2. `grep "json_library, Jason" config/config.exs` returns match
3. `grep "pubsub_server" config/config.exs` returns match
  </verify>
  <done>Config files use Jason and Phoenix 1.7 PubSub syntax</done>
</task>

<task type="auto">
  <name>Task 3: Migrate transport macro and update endpoint</name>
  <files>lib/snaker_web/endpoint.ex, lib/snaker_web/channels/user_socket.ex, lib/snaker/application.ex</files>
  <action>
**lib/snaker_web/endpoint.ex:**
1. Update socket declaration to include websocket option:
   ```elixir
   socket "/socket", SnakerWeb.UserSocket,
     websocket: true,
     longpoll: false
   ```

2. Change json_decoder from Poison to Jason:
   ```elixir
   plug Plug.Parsers,
     parsers: [:urlencoded, :multipart, :json],
     pass: ["*/*"],
     json_decoder: Jason
   ```

**lib/snaker_web/channels/user_socket.ex:**
1. Remove the deprecated transport macro entirely:
   ```elixir
   # DELETE these lines:
   transport :websocket, Phoenix.Transports.WebSocket
   # transport :longpoll, Phoenix.Transports.LongPoll
   ```
   Transport is now configured in endpoint.ex.

**lib/snaker/application.ex:**
1. Remove deprecated Supervisor.Spec import and syntax
2. Update to modern child spec format:
   ```elixir
   def start(_type, _args) do
     children = [
       # PubSub must be started before Endpoint
       {Phoenix.PubSub, name: Snaker.PubSub},
       # Start the endpoint
       SnakerWeb.Endpoint,
       # Start the worker
       {Snaker.Worker, nil}
     ]

     opts = [strategy: :one_for_one, name: Snaker.Supervisor]
     Supervisor.start_link(children, opts)
   end
   ```
  </action>
  <verify>
1. `grep -r "transport :websocket" lib/` returns no matches
2. `grep "websocket: true" lib/snaker_web/endpoint.ex` returns match
3. `grep "json_decoder: Jason" lib/snaker_web/endpoint.ex` returns match
4. `grep "Phoenix.PubSub" lib/snaker/application.ex` returns match
5. `mix compile` succeeds without warnings about deprecated transport
  </verify>
  <done>Transport macro removed, endpoint configured for Phoenix 1.7 WebSocket, application uses modern supervision</done>
</task>

</tasks>

<verification>
Run these commands to verify phase completion:

```bash
# Clean slate - remove old deps and build artifacts
rm -rf deps _build mix.lock

# Fetch and compile with new deps
mix deps.get && mix deps.compile && mix compile

# Start server (should boot without errors)
timeout 10 mix phx.server || true

# Check for Poison references (should be none)
grep -r "Poison" lib/ config/ || echo "No Poison references found - good!"

# Check Jason is configured
grep "json_library, Jason" config/config.exs

# Check WebSocket transport
grep "websocket: true" lib/snaker_web/endpoint.ex
```

Server should start and log Phoenix 1.7.x version.
</verification>

<success_criteria>
1. `mix deps.get` succeeds with Phoenix 1.7.x, Jason, plug_cowboy
2. `mix compile` succeeds with no deprecation warnings
3. `mix phx.server` starts without errors
4. No Poison references remain in codebase
5. WebSocket transport configured via endpoint (not transport macro)
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-modernization/01-02-SUMMARY.md`
</output>
