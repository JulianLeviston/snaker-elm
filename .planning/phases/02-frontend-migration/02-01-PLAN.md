---
phase: 02-frontend-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/package.json
  - assets/build.js
  - assets/tsconfig.json
  - assets/.gitignore
  - config/dev.exs
autonomous: true

must_haves:
  truths:
    - "npm install succeeds in assets directory"
    - "node build.js compiles without errors"
    - "Phoenix watcher triggers rebuild on file changes"
  artifacts:
    - path: "assets/package.json"
      provides: "Node dependencies for esbuild, TypeScript, Elm"
      contains: "esbuild"
    - path: "assets/build.js"
      provides: "esbuild build script with Elm plugin"
      contains: "esbuild-plugin-elm"
    - path: "assets/tsconfig.json"
      provides: "TypeScript configuration with strict mode"
      contains: '"strict": true'
    - path: "config/dev.exs"
      provides: "Phoenix watcher configuration"
      contains: "build.js"
  key_links:
    - from: "config/dev.exs"
      to: "assets/build.js"
      via: "watchers configuration"
      pattern: 'node.*build\\.js.*--watch'
---

<objective>
Replace Brunch with esbuild for asset compilation, including TypeScript and Elm support.

Purpose: Phoenix 1.7+ uses esbuild as the standard asset bundler. The old Brunch setup is incompatible with modern Elm compilation and TypeScript. This plan establishes the build foundation for all frontend work.

Output: Working esbuild pipeline that compiles TypeScript and Elm, with Phoenix dev watcher integration.
</objective>

<execution_context>
@/Users/julian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-frontend-migration/02-RESEARCH.md
@assets/package.json
@assets/brunch-config.js
@config/dev.exs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Brunch and install esbuild toolchain</name>
  <files>
    assets/package.json
    assets/.gitignore
  </files>
  <action>
1. Delete brunch-config.js (will be replaced by build.js)
2. Create new package.json with these dependencies:
   - devDependencies: esbuild, esbuild-plugin-elm, typescript
   - dependencies: phoenix (file:../deps/phoenix), phoenix_html (file:../deps/phoenix_html)
   - scripts: "build": "node build.js", "watch": "node build.js --watch", "deploy": "NODE_ENV=production node build.js"

3. Create/update .gitignore to include node_modules/

4. Run `npm install` in assets directory to install dependencies

5. Verify elm is available via mise (already configured in Phase 1)

Do NOT remove the old node_modules yet - let npm handle cleanup on install.
  </action>
  <verify>
    cd /Users/julian/code/elm/snaker-elm/assets && npm install && npm ls esbuild && npm ls typescript
  </verify>
  <done>
    esbuild and typescript appear in npm ls output, package.json contains correct dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create esbuild configuration with Elm plugin</name>
  <files>
    assets/build.js
    assets/tsconfig.json
  </files>
  <action>
1. Create build.js with esbuild configuration:
   - Entry point: js/app.ts
   - Output: ../priv/static/assets/app.js
   - Bundle: true
   - Target: es2020
   - Sourcemap in dev, minify in production
   - esbuild-plugin-elm with debug in dev, optimize in production
   - Watch mode when --watch flag passed
   - Use esbuild.context() for watch mode (not deprecated build())

2. Create tsconfig.json:
   - strict: true (per user decision)
   - target: ES2020
   - module: ESNext
   - moduleResolution: node
   - esModuleInterop: true
   - Include js/**/*.ts
   - outDir: not needed (esbuild handles output)

Pattern from research:
```javascript
const esbuild = require('esbuild');
const ElmPlugin = require('esbuild-plugin-elm');

const isProduction = process.env.NODE_ENV === 'production';
const isWatch = process.argv.includes('--watch');

async function build() {
  const ctx = await esbuild.context({
    entryPoints: ['js/app.ts'],
    bundle: true,
    outdir: '../priv/static/assets',
    target: 'es2020',
    sourcemap: !isProduction,
    minify: isProduction,
    plugins: [
      ElmPlugin({
        debug: !isProduction,
        optimize: isProduction,
        clearOnWatch: true
      })
    ]
  });

  if (isWatch) {
    await ctx.watch();
    console.log('Watching for changes...');
  } else {
    await ctx.rebuild();
    await ctx.dispose();
  }
}

build().catch(() => process.exit(1));
```
  </action>
  <verify>
    cd /Users/julian/code/elm/snaker-elm/assets && node build.js 2>&1 | head -20
  </verify>
  <done>
    build.js runs without syntax errors (may fail on missing app.ts - that's expected at this stage)
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure Phoenix watcher for esbuild</name>
  <files>
    config/dev.exs
  </files>
  <action>
1. Open config/dev.exs and find the watchers configuration under the Endpoint config

2. Replace any existing Brunch watcher with esbuild watcher:
```elixir
watchers: [
  node: ["build.js", "--watch", cd: Path.expand("../assets", __DIR__)]
]
```

3. Ensure live_reload patterns include the new output path:
```elixir
live_reload: [
  patterns: [
    ~r"priv/static/.*(js|css|png|jpeg|jpg|gif|svg)$",
    ~r"priv/gettext/.*(po)$",
    ~r"lib/snaker_web/(live|views)/.*(ex)$",
    ~r"lib/snaker_web/templates/.*(eex)$"
  ]
]
```

Note: The watcher will automatically rebuild when Elm or TypeScript files change because esbuild watches its dependencies.
  </action>
  <verify>
    grep -A 5 "watchers:" /Users/julian/code/elm/snaker-elm/config/dev.exs
  </verify>
  <done>
    dev.exs contains node watcher pointing to build.js with --watch flag
  </done>
</task>

</tasks>

<verification>
Run full verification:
```bash
cd /Users/julian/code/elm/snaker-elm/assets
npm install
node build.js
# Should complete (may warn about missing entry point)
```

Check file structure:
```bash
ls -la assets/package.json assets/build.js assets/tsconfig.json
```
</verification>

<success_criteria>
1. `npm install` in assets/ completes without errors
2. `node build.js` runs without JavaScript syntax errors
3. package.json contains esbuild, esbuild-plugin-elm, typescript
4. tsconfig.json has strict: true
5. config/dev.exs has node watcher for build.js
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend-migration/02-01-SUMMARY.md`
</output>
