---
phase: 07-migration-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/package.json
  - assets/js/qr-generator.ts
  - assets/js/app.ts
  - assets/src/Ports.elm
  - assets/src/View/ShareUI.elm
  - assets/src/Main.elm
  - assets/css/app.css

autonomous: true

must_haves:
  truths:
    - "Player can copy room code with one click"
    - "Player can copy room URL with one click"
    - "Player sees QR code for room"
    - "Copy button shows 'Copied!' feedback briefly"
    - "QR code is always visible inline at medium size"
  artifacts:
    - path: "assets/js/qr-generator.ts"
      provides: "QR code generation via qrcode library"
      contains: "QRCode.toDataURL"
    - path: "assets/src/View/ShareUI.elm"
      provides: "Share UI component with copy buttons and QR display"
      exports: ["view"]
    - path: "assets/package.json"
      provides: "qrcode dependency"
      contains: "qrcode"
  key_links:
    - from: "assets/src/Main.elm"
      to: "assets/src/View/ShareUI.elm"
      via: "view import"
      pattern: "ShareUI.view"
    - from: "assets/js/qr-generator.ts"
      to: "qrcode"
      via: "npm import"
      pattern: "import QRCode from 'qrcode'"
    - from: "assets/js/app.ts"
      to: "assets/js/qr-generator.ts"
      via: "import and setup"
      pattern: "setupQRPorts"
---

<objective>
Implement room sharing UI with three sharing options: copy room code, copy room URL, and scannable QR code. The QR code is always visible when connected as host, and copy buttons show "Copied!" feedback briefly after clicking.

Purpose: Make it easy for players to share rooms with friends via multiple channels - quick code sharing, link sharing for chat/messages, and QR for in-person.

Output: ShareUI component, QR code generation via qrcode npm library, enhanced copy functionality.
</objective>

<execution_context>
@/Users/julian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-migration-polish/07-CONTEXT.md
@.planning/phases/07-migration-polish/07-RESEARCH.md

@assets/src/Main.elm
@assets/js/peerjs-ports.ts
@assets/src/View/ConnectionUI.elm
@assets/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qrcode and create QR generation port</name>
  <files>assets/package.json, assets/js/qr-generator.ts, assets/js/app.ts, assets/src/Ports.elm</files>
  <action>
    1. Install qrcode library:
       ```bash
       cd assets && npm install qrcode@1.5.5
       ```

    2. Create assets/js/qr-generator.ts:
       ```typescript
       import QRCode from 'qrcode';

       interface QRPorts {
         generateQRCode: { subscribe: (callback: (url: string) => void) => void };
         qrCodeGenerated: { send: (result: { success: boolean; dataUrl?: string; error?: string }) => void };
       }

       interface ElmAppWithQR {
         ports: QRPorts;
       }

       export function setupQRPorts(app: ElmAppWithQR): void {
         app.ports.generateQRCode.subscribe(async (url: string) => {
           try {
             const dataUrl = await QRCode.toDataURL(url, {
               width: 256,
               margin: 2,
               errorCorrectionLevel: 'M',
               color: {
                 dark: '#000000',
                 light: '#FFFFFF'
               }
             });
             app.ports.qrCodeGenerated.send({ success: true, dataUrl: dataUrl });
           } catch (err) {
             console.error('QR generation failed:', err);
             app.ports.qrCodeGenerated.send({
               success: false,
               error: err instanceof Error ? err.message : 'Unknown error'
             });
           }
         });
       }
       ```

    3. In assets/js/app.ts, import and call setupQRPorts:
       ```typescript
       import { setupQRPorts } from './qr-generator';
       // ... after Elm init
       setupQRPorts(app as any);
       ```

    4. In Ports.elm, add:
       ```elm
       port generateQRCode : String -> Cmd msg
       port qrCodeGenerated : (JD.Value -> msg) -> Sub msg
       ```
  </action>
  <verify>
    - `npm install` in assets/ completes without errors
    - `npm run build` compiles TypeScript and Elm
    - package.json contains qrcode dependency
  </verify>
  <done>
    - qrcode@1.5.5 installed in package.json
    - qr-generator.ts creates QR data URLs via port
    - Ports.elm has generateQRCode and qrCodeGenerated ports
    - app.ts calls setupQRPorts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ShareUI.elm with copy and QR display</name>
  <files>assets/src/View/ShareUI.elm, assets/css/app.css</files>
  <action>
    1. Create assets/src/View/ShareUI.elm:
       ```elm
       module View.ShareUI exposing (view, CopyTarget(..))

       type CopyTarget = CopyCode | CopyUrl

       type alias Config msg =
           { roomCode : String
           , qrCodeDataUrl : Maybe String
           , copyCodeState : CopyState
           , copyUrlState : CopyState
           , onCopyCode : msg
           , onCopyUrl : msg
           }

       type CopyState = Ready | Copied
       ```

    2. View layout (appears below room code display):
       - Row of copy buttons:
         - "Copy Code" / "Copied!" button (for room code like "ABCD")
         - "Copy Link" / "Copied!" button (for full URL)
       - QR code image (always visible when qrCodeDataUrl is Just)
         - 256x256 pixels (medium size per user decision)
         - Alt text: "Scan to join room XXXX"

    3. Button styling:
       - Use existing button styles from ConnectionUI
       - "Copied!" state: disabled appearance, green text
       - Transition: brief flash/highlight on copy

    4. Add CSS in app.css for share UI:
       ```css
       .share-ui { margin-top: 1rem; }
       .share-buttons { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
       .copy-button { /* base button styles */ }
       .copy-button.copied { color: #22c55e; /* green */ }
       .qr-code { width: 256px; height: 256px; border: 1px solid #ccc; }
       ```
  </action>
  <verify>
    - `cd assets && npx elm make src/Main.elm --output=/dev/null` compiles
    - Module exports view and CopyTarget type
  </verify>
  <done>
    - ShareUI module renders copy buttons and QR code
    - Copy buttons show "Copy Code"/"Copy Link" normally
    - Copy buttons show "Copied!" when in Copied state
    - QR code displays at 256x256 when dataUrl available
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire ShareUI into Main.elm with copy URL support</name>
  <files>assets/src/Main.elm, assets/js/peerjs-ports.ts</files>
  <action>
    1. Add model fields for ShareUI state:
       ```elm
       , qrCodeDataUrl : Maybe String
       , copyCodeState : ShareUI.CopyState  -- existing showCopiedFeedback becomes this
       , copyUrlState : ShareUI.CopyState
       ```

    2. Add messages:
       ```elm
       | CopyRoomUrl
       | GotQRCodeGenerated JD.Value
       | HideCopiedCodeFeedback
       | HideCopiedUrlFeedback
       ```

    3. When room is created (GotRoomCreated), generate QR code:
       - Build room URL: `window.location.origin + "?room=" + roomCode`
       - Send via generateQRCode port
       - Note: URL construction needs JS help (add port or use flag)

    4. Handle GotQRCodeGenerated:
       - Decode result: `{ success: Bool, dataUrl: Maybe String }`
       - On success: store dataUrl in model.qrCodeDataUrl

    5. Handle CopyRoomUrl:
       - Copy full URL to clipboard via existing copyToClipboard port
       - Set copyUrlState = Copied
       - Schedule HideCopiedUrlFeedback after 2 seconds

    6. Update existing CopyRoomCode to use copyCodeState:
       - Set copyCodeState = Copied
       - Schedule HideCopiedCodeFeedback after 2 seconds

    7. In view, when P2PConnected as Host, show ShareUI:
       ```elm
       ShareUI.view
           { roomCode = roomCode
           , qrCodeDataUrl = model.qrCodeDataUrl
           , copyCodeState = model.copyCodeState
           , copyUrlState = model.copyUrlState
           , onCopyCode = CopyRoomCode
           , onCopyUrl = CopyRoomUrl
           }
       ```

    8. For URL construction, add port to get base URL or pass via flags:
       - Simpler: pass `window.location.origin` in flags
       - Add `baseUrl : String` to Flags type
       - Use in Main.elm: `model.baseUrl ++ "?room=" ++ roomCode`
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Create room shows room code AND QR code
    - "Copy Code" copies just the room code, shows "Copied!"
    - "Copy Link" copies full URL with ?room=XXXX, shows "Copied!"
    - QR code is visible and scannable (test with phone camera)
  </verify>
  <done>
    - QR code generates and displays when room is created
    - Copy Code button copies room code and shows feedback
    - Copy Link button copies full URL and shows feedback
    - ShareUI appears below room code for host
  </done>
</task>

</tasks>

<verification>
1. Build: `cd assets && npm run build` succeeds
2. Start server and create a room
3. Verify QR code appears below room code (256x256)
4. Click "Copy Code" - clipboard has "ABCD" (room code), button shows "Copied!"
5. Wait 2 seconds - button returns to "Copy Code"
6. Click "Copy Link" - clipboard has full URL like "http://localhost:4000?room=ABCD"
7. Button shows "Copied!" then returns after 2 seconds
8. Scan QR code with phone - opens the room URL
</verification>

<success_criteria>
- [ ] qrcode npm package installed
- [ ] QR code generates when room is created
- [ ] QR code displays at medium size (256x256)
- [ ] "Copy Code" copies room code with "Copied!" feedback
- [ ] "Copy Link" copies full room URL with "Copied!" feedback
- [ ] QR code is scannable and opens correct URL
- [ ] Feedback returns to normal state after 2 seconds
- [ ] TypeScript and Elm compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-migration-polish/07-02-SUMMARY.md`
</output>
