---
phase: 07-migration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/js/app.ts
  - assets/src/Main.elm
  - assets/src/View/ModeSelection.elm

autonomous: true

must_haves:
  truths:
    - "Player sees mode selection on first visit"
    - "Player's mode choice is remembered across sessions"
    - "P2P mode is visually primary/larger"
    - "Phoenix mode is visually secondary/smaller"
    - "Player can change mode in settings"
  artifacts:
    - path: "assets/src/View/ModeSelection.elm"
      provides: "Mode selection UI component"
      exports: ["view"]
    - path: "assets/js/app.ts"
      provides: "localStorage integration for mode persistence"
      contains: "snaker-mode"
    - path: "assets/src/Main.elm"
      provides: "Mode selection routing and state"
      contains: "ModeSelectionScreen"
  key_links:
    - from: "assets/js/app.ts"
      to: "localStorage"
      via: "flags on init"
      pattern: "localStorage.getItem.*snaker-mode"
    - from: "assets/src/Main.elm"
      to: "assets/src/View/ModeSelection.elm"
      via: "view import and render"
      pattern: "ModeSelection.view"
---

<objective>
Implement mode selection screen that appears on first visit, allowing players to choose between "Direct Connect" (P2P) and "Classic Online" (Phoenix) modes. The choice is persisted in localStorage so returning players skip the selection and go straight to their preferred mode.

Purpose: Players need a clear entry point to choose between P2P (new) and Phoenix (legacy) modes. This enables dual-mode support while making P2P the primary experience.

Output: Mode selection screen component, localStorage persistence via flags, settings override capability.
</objective>

<execution_context>
@/Users/julian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-migration-polish/07-CONTEXT.md
@.planning/phases/07-migration-polish/07-RESEARCH.md

@assets/src/Main.elm
@assets/js/app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localStorage mode persistence via Elm flags</name>
  <files>assets/js/app.ts, assets/src/Ports.elm</files>
  <action>
    1. In app.ts, read saved mode from localStorage before Elm init:
       ```typescript
       const savedMode = localStorage.getItem('snaker-mode'); // 'p2p' | 'phoenix' | null
       ```

    2. Pass savedMode to Elm via flags:
       ```typescript
       const app = Elm.Main.init({
         node: document.getElementById('elm-main'),
         flags: { savedMode: savedMode }
       });
       ```

    3. Add saveMode port subscription in app.ts:
       ```typescript
       app.ports.saveMode.subscribe((mode: string) => {
         localStorage.setItem('snaker-mode', mode);
       });
       ```

    4. In Ports.elm, add:
       - `port saveMode : String -> Cmd msg` (outgoing)

    Note: Flags type will be updated in Main.elm in Task 2.
  </action>
  <verify>
    - TypeScript compiles: `npm run build` in assets/ succeeds
    - No localStorage errors in browser console when opening the app
  </verify>
  <done>
    - app.ts reads savedMode from localStorage on startup
    - app.ts passes savedMode in flags to Elm.Main.init
    - app.ts subscribes to saveMode port and writes to localStorage
    - Ports.elm exports saveMode port
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ModeSelection.elm view component</name>
  <files>assets/src/View/ModeSelection.elm</files>
  <action>
    Create a new module `View.ModeSelection` with:

    1. Type definitions:
       ```elm
       type Mode = P2PMode | PhoenixMode

       type alias Config msg =
           { onSelectMode : Mode -> msg
           }
       ```

    2. View function showing two mode buttons:
       - "Direct Connect" (P2P) - primary/larger button style, class "mode-button-primary"
       - "Classic Online" (Phoenix) - secondary/smaller button style, class "mode-button-secondary"

    3. Layout:
       - Centered container with title "Choose your mode"
       - Brief description under each button explaining the mode
       - P2P description: "Play directly with friends - no server needed"
       - Phoenix description: "Connect through our game server"

    4. Helper functions:
       - `modeToString : Mode -> String` (returns "p2p" or "phoenix")
       - `modeFromString : String -> Maybe Mode`

    Style using existing CSS patterns from View.ConnectionUI.elm.
  </action>
  <verify>
    - `cd assets && npx elm make src/Main.elm --output=/dev/null` compiles
    - Module exports: view, Mode(..), modeToString, modeFromString
  </verify>
  <done>
    - View.ModeSelection module exists with Mode type and view function
    - P2P button is visually primary (larger)
    - Phoenix button is visually secondary (smaller)
    - Descriptive text explains each mode
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire mode selection into Main.elm with settings override</name>
  <files>assets/src/Main.elm</files>
  <action>
    1. Update Flags type and init:
       ```elm
       type alias Flags =
           { savedMode : Maybe String }

       init : Flags -> ( Model, Cmd Msg )
       init flags =
           case flags.savedMode |> Maybe.andThen ModeSelection.modeFromString of
               Just ModeSelection.P2PMode ->
                   -- Skip to P2P start screen (show connection UI)
                   initWithMode P2PMode

               Just ModeSelection.PhoenixMode ->
                   -- Skip to Phoenix mode (join game)
                   initWithMode PhoenixMode

               Nothing ->
                   -- First visit: show mode selection
                   initModeSelection
       ```

    2. Add Screen type to model:
       ```elm
       type Screen
           = ModeSelectionScreen
           | GameScreen
           | SettingsScreen
       ```

       Add `screen : Screen` field to Model.

    3. Add messages for mode selection:
       ```elm
       | SelectMode ModeSelection.Mode
       | OpenSettings
       | CloseSettings
       | ChangeMode ModeSelection.Mode
       ```

    4. Update view to route based on screen:
       ```elm
       view model =
           case model.screen of
               ModeSelectionScreen ->
                   ModeSelection.view { onSelectMode = SelectMode }

               SettingsScreen ->
                   viewSettings model  -- Show current mode, allow change

               GameScreen ->
                   -- existing game view
       ```

    5. Handle SelectMode: save to localStorage via port, transition to GameScreen

    6. Add settings button (gear icon or "Settings" text) in header area when on GameScreen

    7. SettingsScreen: show current mode with option to change (calls ChangeMode)

    8. Update main to use Flags:
       ```elm
       main : Program Flags Model Msg
       ```

    9. Update JSON decoder for flags (nullable string).
  </action>
  <verify>
    - `cd assets && npx elm make src/Main.elm --output=/dev/null` compiles
    - `npm run build` in assets/ succeeds
    - Opening app fresh (cleared localStorage) shows mode selection
    - Selecting P2P saves "p2p" to localStorage and shows P2P UI
    - Refreshing skips mode selection, goes straight to P2P UI
    - Settings allows changing mode
  </verify>
  <done>
    - Player sees mode selection on first visit
    - Selecting a mode saves it and transitions to game
    - Returning player skips selection, goes to saved mode
    - Settings screen allows changing mode preference
  </done>
</task>

</tasks>

<verification>
1. Clear localStorage: `localStorage.removeItem('snaker-mode')` in browser console
2. Refresh page - mode selection screen appears
3. Click "Direct Connect" - P2P UI appears, localStorage has "p2p"
4. Refresh page - skips to P2P UI directly
5. Open settings - shows current mode as P2P
6. Change to Phoenix - localStorage updates to "phoenix"
7. Refresh - goes to Phoenix mode

Full build verification: `npm run build` in assets/ completes without errors
</verification>

<success_criteria>
- [ ] Mode selection screen shows on first visit (no localStorage)
- [ ] P2P mode button is primary/larger, Phoenix is secondary/smaller
- [ ] Mode choice persists in localStorage as "p2p" or "phoenix"
- [ ] Returning visitors skip selection and go to saved mode
- [ ] Settings accessible from game screen
- [ ] Mode can be changed in settings
- [ ] TypeScript and Elm compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-migration-polish/07-01-SUMMARY.md`
</output>
